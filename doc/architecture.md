# A股盘后静态分析系统架构文档

## 1. 系统概述

### 1.1 系统定位
本系统是一个专注于A股市场的盘后静态数据分析系统，主要用于交易日结束后的数据分析和研究。系统采用单体应用架构，通过命令行工具提供数据同步功能。

### 1.2 核心特性
- **双数据源支持**：pytdx（通达信数据）+ baostock（基本面数据）
- **双存储机制**：CSV文件 + PostgreSQL数据库
- **模块化设计**：高内聚低耦合的模块结构
- **批处理优化**：针对大数据量场景的性能优化
- **错误恢复**：自动重试和错误处理机制

## 2. 架构设计

### 2.1 整体架构

```
CLI命令行层
    │
应用服务层 (SyncManager, ConfigManager, ErrorHandler)
    │
数据访问层 (DataSource, Database, CsvWriter)
    │
存储层 (PostgreSQL, CSV文件, 通达信数据)
```

### 2.2 核心模块

#### 2.2.1 数据同步模块
- **SyncManager**：同步协调器，负责整体同步流程
- **TaskExecutor**：任务执行器，支持并行执行和重试机制
- **DataPipeline**：数据管道，实现ETL流程
- **CsvWriter**：CSV文件写入器

#### 2.2.2 数据源模块
- **DataSourceBase**：数据源抽象基类
- **PytdxSource**：通达信数据源实现
- **BaostockSource**：Baostock数据源实现

#### 2.2.3 数据库模块
- **DatabaseConnection**：数据库连接管理
- **Models**：数据模型定义（Stock, DailyData, FinancialData）

#### 2.2.4 配置管理模块
- **ConfigManager**：配置管理器
- **ConfigValidator**：配置验证器

#### 2.2.5 工具模块
- **Logger**：日志系统
- **Exceptions**：自定义异常类

## 3. 数据流程

### 3.1 数据同步流程

```
1. 初始化
   ├─ 加载配置
   ├─ 验证配置
   └─ 初始化数据源

2. 数据提取
   ├─ 连接数据源
   ├─ 提取数据
   └─ 断开连接

3. 数据处理
   ├─ 数据验证
   ├─ 数据转换
   └─ 批量处理

4. 数据存储
   ├─ 保存到CSV
   └─ 保存到数据库
```

### 3.2 错误处理流程

```
异常捕获
    ├─ 记录日志
    ├─ 判断重试次数
    ├─ 指数退避等待
    └─ 重试或失败
```

## 4. 关键设计决策

### 4.1 为什么选择单体架构？
- **简单性**：适合当前需求，避免分布式复杂性
- **性能**：本地处理，无网络开销
- **维护性**：代码集中，便于调试和部署
- **扩展性**：模块化设计支持后续拆分

### 4.2 为什么使用双存储？
- **CSV文件**：便于数据交换和备份
- **数据库**：支持复杂查询和分析
- **灵活性**：根据场景选择合适的存储

### 4.3 为什么采用批处理？
- **性能**：减少I/O操作次数
- **内存控制**：避免大数据量导致的内存溢出
- **进度跟踪**：便于监控同步进度

## 5. 性能优化策略

### 5.1 数据库优化
- 使用批量插入（INSERT ... ON CONFLICT）
- 合理设置batch_size（默认1000）
- 使用索引优化查询

### 5.2 内存优化
- 流式处理大数据文件
- 及时释放不需要的数据
- 使用生成器减少内存占用

### 5.3 并发优化
- 多线程并行处理不同股票
- 控制并发数量（默认4个线程）
- 使用线程池管理资源

## 6. 扩展性设计

### 6.1 新增数据源
1. 继承DataSourceBase
2. 实现必要方法
3. 在ConfigManager中注册

### 6.2 新增数据类型
1. 定义数据模型
2. 实现Pipeline处理阶段
3. 添加存储逻辑

### 6.3 新增同步任务
1. 继承SyncTask
2. 实现execute方法
3. 集成到SyncManager

## 7. 安全性考虑

### 7.1 数据安全
- 配置文件敏感信息加密
- 数据库连接使用SSL
- 定期备份重要数据

### 7.2 系统安全
- 输入参数验证
- SQL注入防护
- 异常信息脱敏

## 8. 监控和运维

### 8.1 日志管理
- 分级日志记录
- 日志文件轮转
- 错误告警机制

### 8.2 性能监控
- 同步进度跟踪
- 执行时间统计
- 错误率监控

### 8.3 运维工具
- 系统状态检查命令
- 数据一致性校验
- 增量同步支持

## 9. 部署建议

### 9.1 环境要求
- Python 3.8+
- PostgreSQL 12+
- 足够的磁盘空间（建议100GB+）

### 9.2 部署步骤
1. 安装依赖包
2. 配置环境变量
3. 初始化数据库
4. 执行初始同步

### 9.3 维护建议
- 定期检查日志
- 监控磁盘空间
- 定期数据备份
- 更新股票列表