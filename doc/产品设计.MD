# 股票静态分析系统产品设计文档

## 系统概述

作为专业的股票数据分析系统开发专家，我们将基于以下需求设计并实现一套完整的股票静态分析系统。该系统专注于A股市场的盘后数据分析，核心功能涵盖数据同步和股票分析两大模块。

## 核心设计原则

### 数据质量与真实性原则

#### 数据源可靠性原则
- **源数据可验证性**：所有数据必须来自经过严格验证的真实数据源
- **数据篡改零容忍**：杜绝任何形式的数据修改、伪造或模拟行为

#### 数据记录完整性原则
- **分级获取策略**：
  - 第一优先级：直接从官方数据源获取原始数据
  - 第二优先级：通过可靠计算模型推导相关数据
  - 第三优先级：无法获取则明确标注并记录具体原因

### 技术架构与工程原则

#### 技术栈统一性原则
- **开发语言与框架**：采用Python 3.8+作为后端主要开发语言，支持异步架构
- **数据库选型标准**：使用PostgreSQL 12+作为主数据库，扩展支持TimescaleDB时序数据处理
- **技术兼容性保证**：确保所有技术组件版本兼容，降低系统集成复杂度

#### 架构设计原则
- **接口标准化原则**：
  - 抽象数据源接口设计，支持热插拔机制
  - 统一数据存储接口标准，支持多种存储后端
  - 规范化分析处理接口，确保系统间协作效率
- **插件化架构原则**：采用模块化插件架构，新增功能无需修改核心代码
- **配置驱动原则**：通过统一配置文件管理数据源和分析策略，提升系统灵活性

#### 多数据源管理原则
- **数据源优先级策略**：
  - 主要数据源：pytdx（负责K线数据）、baostock（负责基本面数据）
  - 数据源协同机制：严格按照数据来源说明进行数据采集，确保数据一致性
  - 扩展接口规范：预留标准化数据源接入接口，支持未来数据源扩展

#### 系统模块化设计原则
- **模块独立性原则**：确保各功能模块高内聚、低耦合
- **接口清晰定义**：明确模块间接口标准，降低系统集成复杂度

### 开发与维护原则

#### 代码质量与可维护性原则
- **代码规范一致性**：遵循统一的编码规范和最佳实践
- **文档完整性要求**：确保技术文档、API文档和用户文档的完整性和时效性

### 工程目录结构

- **后端代码**：backend
- **后端单元测试**：backend/test
- **后端配置文件**：backend/config
- **前端代码**：front
- **前端单元测试**：front/test
- **正式文档**：doc

## 核心功能模块

### 数据同步功能

#### 功能特性

- **手动触发同步**：用户可通过命令行或API手动触发数据同步
- **日期范围选择**：支持指定起始和结束日期进行数据同步
- **多维度数据采集**：支持按市场（沪市、深证、北交所）和指定股票编码进行数据采集
- **双存储策略**：数据同时保存为CSV文件和数据库记录
- **并发控制机制**：采用多线程进行数据采集
- **进度实时监控**：实时显示同步进度和状态
- **采集结果反馈**：数据采集结束时显示采集总量、成功数量、失败数量及具体失败股票编码

#### 同步流程优化

```
开始同步
    ↓
参数验证与预处理
    ↓
数据源连接与验证
    ↓
数据分片与任务分配
    ↓
并行数据采集（多线程/协程）
    ↓
数据清洗与转换
    ↓
数据质量检查
    ↓
双存储写入（CSV + Database）
    ↓
数据完整性校验
    ↓
生成同步报告
    ↓
清理临时资源
    ↓
结束同步
```

#### 数据同步详情表

| 功能模块 | 通达信数据目录 | CSV文件存放目录 | CSV文件命名规则 | 数据库表名 |
|---------|---------------|----------------|----------------|-----------|
| 股票基本信息同步 | 无 | {csv文件根目录}/base_stock_info | base_stock_info_{yyyyMMdd}.csv | base_stock_info |
| 股票基本面信息同步 | 无 | {csv文件根目录}/base_fundamentals_info | base_fundamentals_info_{yyyyMMdd}.csv | base_fundamentals_info |
| 指数数据同步 | -- | -- | -- | -- |
| 日K线数据同步 | {通达信数据根目录}/vipdoc/{market}/lday | {csv文件根目录}/his_kline_day | his_kline_day_{yyyyMMdd}.csv | his_kline_day |
| 周K线数据同步 | -- | -- | -- | -- |
| 月K线数据同步 | -- | -- | -- | -- |
| 1分钟K线数据同步 | {通达信数据根目录}/vipdoc/{market}/minline | {csv文件根目录}/his_kline_1min | his_kline_1min_{yyyyMMdd}.csv | his_kline_1min |
| 5分钟K线数据同步 | {通达信数据根目录}/vipdoc/{market}/fzline | {csv文件根目录}/his_kline_5min | his_kline_5min_{yyyyMMdd}.csv | his_kline_5min |
| 30分钟K线数据同步 | -- | -- | -- | -- |
| 60分钟K线数据同步 | -- | -- | -- | -- |

*注：`{market}` 可为 `bj`（北交所）、`sh`（沪市）、`sz`（深市）*

#### 数据来源说明

##### 股票基本信息同步

| 字段名 | 描述 | baostock方案 |
|--------|------|--------------|
| ts_code | TS代码 | 通过bs.query_stock_basic()获取code字段，格式转换为{code}.SZ或{code}.SH |
| stock_code | 股票编码 | 通过bs.query_stock_basic()获取code字段，去除市场前缀sz./sh.提取6位代码 |
| stock_name | 股票名称 | 通过bs.query_stock_basic()获取code_name字段 |
| cnspell | 拼音缩写 | 无法通过接口直接获取，需要使用pypinyin库计算生成 |
| market_code | 市场编码 | 通过code字段前缀判断，sz.开头为sz，sh.开头为sh |
| market_name | 市场名称 | 根据code前缀映射市场名称，sz.=深圳证券交易所、sh.=上海证券交易所 |
| exchange_code | 交易所编码 | 根据code前缀映射交易所编码，sz.=SZSE、sh.=SSE |
| sector_code | 板块编码 | 无法通过baostock接口直接获取板块编码 |
| sector_name | 板块名称 | 无法通过baostock接口直接获取板块名称 |
| industry_code | 行业编码 | 通过bs.query_stock_industry()获取industry |
| industry_name | 行业名称 | 通过bs.query_stock_industry()获取industry |
| list_status | 上市状态（L上市 D退市 P暂停上市） | 通过bs.query_stock_basic()获取status字段，1=上市(L)、0=退市(D) |
| list_date | 上市日期 | 通过bs.query_stock_basic()获取ipoDate字段，格式为YYYY-MM-DD |
| delist_date | 退市日期 | 通过bs.query_stock_basic()获取outDate字段，格式为YYYY-MM-DD |

##### 股票基本面信息同步

| 字段名 | 描述 | baostock方案 |
|--------|------|--------------|
| stock_code | 股票编码 | 通过bs.query_stock_basic()获取code字段，去除市场前缀sz./sh.提取6位代码 |
| disclosure_date | 信息披露日期 | 通过bs.query_profit_data()获取报告日期，通常为季度末日期 |
| total_share | 总股本 | 通过bs.query_profit_data()获取totalShare字段，单位为股 |
| float_share | 流通股本 | 通过bs.query_profit_data()获取floatShare字段，单位为股 |

##### 日K线数据同步

通达信数据文件目录结构：
- 北交所股票数据：vipdoc/bj/lday
- 沪市股票数据：vipdoc/sh/lday
- 深证股票数据：vipdoc/sz/lday

| 字段名 | 描述 | pytdx文件方案 |
|--------|------|---------------|
| ts_code | TS代码 | 从.day文件名提取6位代码，结合路径推导格式为{code}.SZ或{code}.SH |
| stock_code | 股票编码 | 从.day文件名提取前6位作为股票编码 |
| stock_name | 股票名称 | 通过股票基本信息表映射获取股票名称 |
| trade_date | 交易日 | 从.day文件解析时间戳转换为YYYY-MM-DD格式 |
| open | 今日开盘价 | 通过DailyBarReader解析.day文件获取open字段 |
| high | 最高价 | 通过DailyBarReader解析.day文件获取high字段 |
| low | 最低价 | 通过DailyBarReader解析.day文件获取low字段 |
| close | 今日收盘价 | 通过DailyBarReader解析.day文件获取close字段 |
| preclose | 昨日收盘价 | 通过DailyBarReader解析.day文件获取last_close字段 |
| volume | 成交量 | 通过DailyBarReader解析.day文件获取vol字段 |
| amount | 成交额 | 通过DailyBarReader解析.day文件获取amount字段 |
| trade_status | 交易状态 | 无法直接从文件获取，需要结合交易日历判断 |
| is_st | 是否ST股 | 通过股票名称判断是否包含ST标记 |
| adjust_flag | 复权状态 | 默认为不复权状态，需要额外配置 |
| change_rate | 涨跌幅 | 通过公式计算：(close-preclose)/preclose*100 |
| turnover_rate | 换手率 | 通过公式计算：volume/float_share*100，需要流通股本数据 |
| pe_ttm | 滚动市盈率 | 无法直接从文件获取，需要财务数据配合计算 |
| pb_rate | 市净率 | 无法直接从文件获取，需要财务数据配合计算 |
| ps_ttm | 滚动市销率 | 无法直接从文件获取，需要财务数据配合计算 |
| pcf_ttm | 滚动市现率 | 无法直接从文件获取，需要财务数据配合计算 |

##### 1分钟K线数据同步

通达信数据文件目录结构中.lc1结尾的文件：
- 北交所股票数据：vipdoc/bj/minline
- 沪市股票数据：vipdoc/sh/minline
- 深证股票数据：vipdoc/sz/minline

| 字段名 | 描述 | pytdx文件方案 |
|--------|------|---------------|
| ts_code | ts代码 | 从.lc1文件名提取6位代码，结合路径推导格式为{code}.SZ或{code}.SH |
| stock_code | 股票编码 | 从.lc1文件名提取前6位作为股票编码 |
| stock_name | 股票名称 | 通过股票基本信息表映射获取股票名称 |
| trade_date | 交易日 | 从.lc1文件解析时间戳转换为YYYY-MM-DD格式 |
| trade_time | 交易时间 | 从.lc1文件解析时间戳转换为HH:MM格式 |
| open | 今日开盘价 | 通过MinuteBarReader解析.lc1文件获取open字段 |
| high | 最高价 | 通过MinuteBarReader解析.lc1文件获取high字段 |
| low | 最低价 | 通过MinuteBarReader解析.lc1文件获取low字段 |
| close | 今日收盘价 | 通过MinuteBarReader解析.lc1文件获取close字段 |
| volume | 成交量 | 通过MinuteBarReader解析.lc1文件获取vol字段 |
| amount | 成交额 | 通过MinuteBarReader解析.lc1文件获取amount字段 |
| adjust_flag | 复权状态 | 默认为不复权状态，需要额外配置 |
| change_rate | 涨跌幅 | 通过公式计算：(close-preclose)/preclose*100 |
| turnover_rate | 换手率 | 通过公式计算：volume/float_share*100，需要流通股本数据 |

##### 5分钟K线数据同步

通达信数据文件目录结构中.lc5结尾的文件：
- 北交所股票数据：vipdoc/bj/fzline
- 沪市股票数据：vipdoc/sh/fzline
- 深证股票数据：vipdoc/sz/fzline

| 字段名 | 描述 | pytdx文件方案 |
|--------|------|---------------|
| ts_code | ts代码 | 从.lc5文件名提取6位代码，结合路径推导格式为{code}.SZ或{code}.SH |
| stock_code | 股票编码 | 从.lc5文件名提取前6位作为股票编码 |
| stock_name | 股票名称 | 通过股票基本信息表映射获取股票名称 |
| trade_date | 交易日 | 从.lc5文件解析时间戳转换为YYYY-MM-DD格式 |
| trade_time | 交易时间 | 从.lc5文件解析时间戳转换为HH:MM格式 |
| open | 今日开盘价 | 通过MinuteBarReader解析.lc5文件获取open字段 |
| high | 最高价 | 通过MinuteBarReader解析.lc5文件获取high字段 |
| low | 最低价 | 通过MinuteBarReader解析.lc5文件获取low字段 |
| close | 今日收盘价 | 通过MinuteBarReader解析.lc5文件获取close字段 |
| volume | 成交量 | 通过MinuteBarReader解析.lc5文件获取vol字段 |
| amount | 成交额 | 通过MinuteBarReader解析.lc5文件获取amount字段 |
| adjust_flag | 复权状态 | 默认为不复权状态，需要额外配置 |
| change_rate | 涨跌幅 | 通过公式计算：(close-preclose)/preclose*100 |
| turnover_rate | 换手率 | 通过公式计算：volume/float_share*100，需要流通股本数据 |

### 股票分析功能

#### 立体K线数据生成

**功能描述：**
基于5分钟K线数据，按照价格变动幅度重新聚合K线，生成"立体K线"，突破传统时间维度的K线分析限制。

**生成规则：**
1. **触发条件**：股价相对于当前立体K线的开盘价涨幅达到2.5%
2. **K线生成逻辑**：
   - 每根立体K线代表一次涨幅2.5%的价格变动区间
   - 包含该区间内的：开盘价、最高价、最低价、收盘价
   - 成交量、成交额、换手率为区间内累计值
3. **时间标记**：使用区间结束时间作为K线时间戳

**算法流程：**
```
输入：5分钟K线数据，股票代码，起始日期，结束日期
输出：立体K线序列

步骤：
1. 按时间顺序读取5分钟K线
2. 初始化第一根立体K线：
   - 开盘价 = 第一个5分钟K线的开盘价
   - 当前参考价 = 开盘价
3. 遍历后续5分钟K线：
   a. 计算当前价相对于参考价的涨跌幅
   b. 如果涨幅 ≥ 2.5%：
      - 生成新的立体K线
      - 更新参考价为新K线的收盘价
   c. 否则：累积到当前立体K线
4. 输出所有生成的立体K线
```

**输出字段说明：**

| 字段名 | 描述 | 数据来源 |
|--------|------|----------|
| ts_code | TS代码 | 股票ts_code |
| stock_code | 股票编码 | 股票编码 |
| stock_name | 股票名称 | 股票名称 |
| trade_date | 交易日 | 区间结束时间的K线交易日 |
| trade_time | 交易时间 | 区间结束时间的K线交易时间 |
| open | 开盘价 | 区间开始时间的K线open价格 |
| high | 最高价 | 区间内K线的high价格 |
| low | 最低价 | 区间内K线的low价格 |
| close | 收盘价 | 区间结束时间的K线的close价格 |
| volume | 成交量 | 区间内股票成交量累计值 |
| amount | 成交额 | 区间内股票成交额累计值 |
| change_rate | 涨跌幅 | 区间内股票涨跌幅累计值，理论值应固定为2.5% |
| turnover_rate | 换手率 | 区间内股票累积换手率 |

## 实施指导与最佳实践

### 数据源管理实践

#### 数据源接入规范
- **接口调用规范**：制定标准化的数据源接口调用规范
- **数据格式标准化**：统一数据输入输出格式，降低集成复杂度

#### 数据源限制管理
- **频率限制应对策略**：
  - pytdx接口：实施合理的并发调用控制和请求间隔管理
  - baostock接口：建立会话自动续期机制，确保30分钟会话有效期

### 性能优化实践

#### 数据处理性能优化
- **批量处理策略**：实施大数据集的分批处理机制，避免内存溢出
- **并行计算优化**：
  - 采用多线程/协程技术提升数据处理效率
  - 设计合理的任务分片和负载均衡策略

#### 存储性能优化
- **数据库优化策略**：
  - 合理设计表结构和索引，优化查询性能
  - 实施数据库连接池管理和查询优化
- **文件存储优化**：
  - 优化CSV文件读写性能
  - 考虑Parquet格式存储，提升大数据集处理效率

### 数据质量保障实践

#### 数据完整性保障
- **实时监控体系**：建立数据同步状态的实时监控机制
- **完整性校验机制**：实施多层次的数据完整性校验

### 系统监控与运维实践

#### 同步状态监控
- **同步过程追踪**：详细记录每次同步的起止时间和执行状态
- **结果统计分析**：统计成功/失败的股票数量，记录具体失败股票编码
- **同步报告生成**：自动生成详细的同步执行报告

### 系统配置与部署实践

#### 配置管理实践
- **配置化分析策略**：
  - 立体K线参数可配置：支持2.5%等关键参数灵活调整
  - 分析结果输出格式可扩展配置
- **环境配置管理**：建立多环境配置管理体系

### 开发规范与标准化实践

#### 数据格式标准化
- **CSV格式规范**：UTF-8编码，逗号分隔，首行为字段名
- **Parquet格式规范**：采用Snappy压缩，实施分区存储策略
- **JSON格式规范**：API响应采用标准JSON格式
- **数据库格式规范**：严格遵守PostgreSQL数据类型和命名规范

#### 编码与文档规范
- **Python编码规范**：遵循PEP8规范，推荐使用Black进行代码格式化
- **SQL编写规范**：使用大写关键字，明确字段别名
- **配置文件格式**：采用YAML格式，保持层级结构清晰
- **日志格式标准**：采用结构化日志格式，便于后续解析分析
- **文档管理规范**：建立完善的文档编写、更新和维护流程

### 性能基准与测试实践

#### 性能基准指标
- **同步性能基准**：1000只股票日K线数据同步时间应小于5分钟
- **查询响应基准**：单股票历史数据查询响应时间应小于100ms
- **分析计算基准**：立体K线生成时间应小于1秒/股票
- **系统并发基准**：系统应支持100+并发查询

## 其他说明

### 数据来源参考

1. **pytdx**
   - GitHub仓库：https://github.com/rainx/pytdx/tree/master
   - 接口文档：https://rainx.gitbooks.io/pytdx/content/

2. **baostock**
   - 接口文档：http://www.baostock.com/mainContent?file=home.md

### 术语表

- **TS代码**：包含交易所信息的股票代码，格式如000001.SZ
- **复权状态**：股票价格经过除权除息调整后的状态
- **立体K线**：按价格变动幅度而非固定时间间隔生成的K线
